//go:build ignore

package main

import (
	"fmt"
	"strings"
)

const (
	up = iota
	right
	down
	left
)

type blockPos struct{ x, y, dir int }

func main() {
	dir := up
	var cx, cy int
	var sx, sy int
	bps := make([]blockPos, 4)
	for i := range bps {
		bps[i] = blockPos{-1, -1, -1}
	}
	lines := strings.Split(input, "\n")
	var maps [][]rune
	for _, line := range lines {
		maps = append(maps, []rune(line))
	}
	my := len(maps) - 1
	mx := len(maps[0]) - 1
	for i := range maps {
		for j := range maps[i] {
			if maps[i][j] == '^' {
				sx, sy = j, i
				maps[i][j] = '.'
			}
		}
	}
	move := func() {
		switch dir {
		case up:
			cy--
		case right:
			cx++
		case down:
			cy++
		case left:
			cx--
		}
	}
	pushBlockPos := func(x, y, d int) {
		bps = append(bps, blockPos{x, y, d})
	}
	isBlockedAndLoop := func() (bool, bool) {
		bp := blockPos{-1, -1, dir}
		switch dir {
		case up:
			bp.y, bp.x = cy-1, cx
		case right:
			bp.y, bp.x = cy, cx+1
		case down:
			bp.y, bp.x = cy+1, cx
		case left:
			bp.y, bp.x = cy, cx-1
		}
		if maps[bp.y][bp.x] == '#' {
			for p := range bps {
				if bps[p] == bp {
					return true, true
				}
			}

			pushBlockPos(bp.x, bp.y, bp.dir)
			return true, false
		}
		return false, false

	}
	isFinish := func() bool {
		switch dir {
		case up:
			return cy-1 < 0
		case right:
			return cx+1 > mx
		case down:
			return cy+1 > my
		case left:
			return cx-1 < 0
		}
		return false
	}
	turn := func() {
		switch dir {
		case up:
			dir = right
		case right:
			dir = down
		case down:
			dir = left
		case left:
			dir = up
		}

	}

	var count int
	for y := range maps {

		for x := range maps[y] {

			if maps[y][x] == '#' {
				continue
			}
			maps[y][x] = '#'

			cx, cy = sx, sy
			dir = up
			bps = make([]blockPos, 4)
			for i := range bps {
				bps[i] = blockPos{-1, -1, dir}
			}

			for {
				if isFinish() {
					break
				}
				b, l := isBlockedAndLoop()
				if l {
					count++
					break
				}
				if b {
					turn()
					continue
				}
				move()
			}

			maps[y][x] = '.'

		}

	}
	fmt.Println(count)
}

var sampleInput = `....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...`

var input = `..#.....##......#............#..................................#.....#..............#................#.........................#.
..........................................................................................................#..........#...#.......#
..................#....................#.......................................#.....#....#............#.......#..................
......#...#..##....................................................................#...#.......#..........#..#.....#..............
..#..#.#.............#.#.........#.........##..................#..............#..........................#........................
#..........#.................#..........#...............................#..#.................#.......##..##..#.#..................
......................#......................................................#........................#......................#....
........................#.#.....................................#..............................#.......#.............#.....#......
#.................#...#......#..........#.......#.....#............................................#...........##.........#.....#.
...........................................#.....#............##...............#..............................#...................
.....#..............#......................................#..........#............#..................##...............#......###.
..............#..#.....................................##................#............................#............#......#.......
#........#...................................................#..........................................#.........................
.................................................................................#................................#....#..#..#....
.............................#.###.........#.#...............#..........................................##........................
......................................................................................................................#.........#.
...............#............#............#...#.........#............#.............................#.#........................#....
........................#...............#...............#........#.........#................#....#.#....................#.........
........#...............#...........................................................................................#.............
.................#..........................................................#.....................................................
........#.#.#...................#..#.......#...........#..#............#......#.....................#.....#.........#..#..........
..#.......#..................................................................................................#......#.............
................##...##......................#....................................................#..............................#
............#......................................#...........................#.#...#...............#.....................##.....
..........#...................#.....................#...........................................##................................
.#.......................#...............................................................#........................................
...................................................................#..#................#.....#....................#...............
...........#...........................................................#..........................................................
.....#....#..#..........................................................#..................#.....................##...............
...#................................#.....#...................#...............##...........#..............#.......................
.......##.....#.............#..#.......................................................................#......................#...
......................................#....#.............................................#...#....................#...............
.......#.......#...............#..#.....#..............................#.#......#...............#.................................
......................#.......#.......#..........................................................#................#...........#...
..............................#........................#.......#..#...............................#...............................
...........................#..........#..##.......................#................#..............................................
..............#............#...##........#.................................#................#....#........................#..#....
..............#.........#............................................#.............#......#......#.#....#.........................
.......................#.................................#..#..#..#..............................................#................
........................###..#...............................................................#.........#................#......#..
#........................................................................................#........................................
........................................#..............................##.....#.........................#...........#.............
.............#.........#...#................#..#..........#.....#...........................................................#.....
.......................................#......#.............................#.........#................#..........................
..........................................................#......................#...........#...#.......#........................
#.....................................#.#...#.............................................................#...........#........#..
............................#..................................................................................#............#.....
#.................#.................................................................#..............#...................#..........
........#...................................................................#...............................................#.....
.................#...#..................#.............................................................#.......#...................
...#.....#.................................................................................................#..........#...........
..........#...................................#....#................#......#........................................#.......#.....
.....................................#...............#................................................................#...........
.#............#................................................................#.............................................#....
...........#.........#.....................#...........#^.......................#.....................#..........#................
.....#........#.................................................................................................#.......#.........
..........#..........................#.......#......................#..............................#....#......................#..
...#.........................#.................#....#........#....................................................................
...............#...#........................................#................................#....#........................#.#....
...........#.......................................#......#....#.......................................................#.......#..
#.........#...............#..#..#..........#..............#...........................#...........#.....................#.........
...................#.......................................................#......................................................
.............#..............................................#.......................................#.........#...........#......#
....#......#...#.................................#.....#......#.................................#.................................
...............#...............#......................................................................#...........................
.......................#.........................................................................................................#
.............................#............................................................................#.......................
...................#..#.........#...........................#......#...............#......#.......................................
...#....................................#...................#..#...........................#............#...............#........#
...................#................................................................#............##...............................
........................#.#...................#.....................................................................#...#.........
...................#......#.......#.#......................................................#...............#......................
....#...........................#................#.............................#..#....................#........##.....#..........
.........................#......................................................#.#......................................#........
.........#.............#.................#........................................................................................
.#.#.......#..#....#.......#...#..#......................................................................#.#......................
..#.................#............................................................................#................................
.#................................#...............................................................................................
..........#............#..............................................#...#...............##...............#..................#...
................................#.........................#.......................................................................
........................................................##.......#........................#.....................#.................
......#......................................................#......#.........#........................................#.......#..
...........................................................#............#....#......#.............................................
..................................#...................................................#.................................#...#.....
.......#...#..........#............#.......#........................................#..#.................#........................
....................#........................................#........#...........................................................
.................................##..#............#.................................#.............#..................#....#.......
.#.................#..........#.....#...........#.......................................................#...................#.....
........................#.........................................................................................................
...#..........................................#...........................#.................................#.....................
............#......................................................#.................................#.........#..............#...
.............#........##.........#..................#...#.............#......#....##................#................#............
..................#...........................................................................................#.................#.
.....................#..#..#....................#........................#.........#................................#.............
..............................................#...................#............................#..............................#...
.......................#.#...................................#.............................#...................................#..
................................#...........#.............................#.............#.........#..............................#
...........................#................................#...................................................#.....#...........
..........#..........#.....#..........#..#............#..........#.................#.......#.......#........................#....#
...#.......#...#..............................................................................................#......#......#.....
...........#......................#..#.................#......#.........#.....#.............#............##................#....#.
.......#...........................................#..................#...............#.............................#.............
....#.......#.................................#..................................................................#................
..#..................................#...#............................#.........#....#..........#............................#....
....................................................#.................#...........................................#...............
............#......................................#.........#..................#.....#.#.#.#..#..................................
#..............#.......#...#.#..............#.....#.#.............................................................................
...........#.#.................................#...#........................................#................#.........#....#.....
......#.........................................#.........................#...........................................#...........
...#......#.................................#......#............................................................................#.
...#.................#....##................#...........................................#.........#....#..........................
...........#...#...#..................#...................................#......................................#......#.....#.#.
...................................#....................#................#..................................................#.....
................#.....................................#...........#......#........................................................
..............................#......#..#..............................................##........#......#......................#.#
#...........................#....#....##.....#...........................##..#...................#.....#........#.................
..........#....#.#..................#..........#..#................#.................#..................................##.......#
...................#.....................#......#...........................................................#..........#..........
........#.....#.............................#..............................................#......................................
......#............#.#.................................................................................................#..#.......
.#.........#..................................................................................#....#...........#.................#
........#.....#.......................#.........................................#...........................................#.....
...................#.......#..#......#.................##......................................#...................#..............
.............................#.................................#........#.......#..................................#.........#....
....#....#..........#....###..#...................................................#...#................................#.......#..
...................#...................................................#.......#....#........................#....................
...#................#...........#.......................#.....................................#...#......#......#.................
.......#........................#.........#.............................................................#...#...#.................
....................#.........#..............................#..........................#....................#..#.................
..#..........................#.#...................................#..................#..........#................#...............`
